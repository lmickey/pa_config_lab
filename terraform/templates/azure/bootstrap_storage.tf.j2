# Bootstrap Storage Account and Containers
# Generated by pa_config_lab TerraformGenerator

{% if firewalls or panorama %}
# =============================================================================
# Storage Account for Bootstrap Packages
# =============================================================================

resource "random_string" "storage_suffix" {
  length  = 8
  special = false
  upper   = false
}

resource "azurerm_storage_account" "bootstrap" {
  name                     = "bootstrap${random_string.storage_suffix.result}"
  resource_group_name      = azurerm_resource_group.main.name
  location                 = azurerm_resource_group.main.location
  account_tier             = "Standard"
  account_replication_type = "LRS"
  min_tls_version          = "TLS1_2"

  # Allow blob public access for bootstrap (VMs need to pull config)
  allow_nested_items_to_be_public = true

  tags = var.tags
}

# =============================================================================
# Bootstrap Containers for Firewalls
# =============================================================================

{% for fw in firewalls %}
resource "azurerm_storage_container" "{{ fw.name | replace('-', '_') }}_bootstrap" {
  name                  = "{{ fw.name }}-bootstrap"
  storage_account_name  = azurerm_storage_account.bootstrap.name
  container_access_type = "blob"  # Public read access for bootstrap
}

# Upload bootstrap files for {{ fw.name }}
resource "azurerm_storage_blob" "{{ fw.name | replace('-', '_') }}_init_cfg" {
  name                   = "config/init-cfg.txt"
  storage_account_name   = azurerm_storage_account.bootstrap.name
  storage_container_name = azurerm_storage_container.{{ fw.name | replace('-', '_') }}_bootstrap.name
  type                   = "Block"
  source                 = "${path.module}/bootstrap/{{ fw.name }}/config/init-cfg.txt"
}

resource "azurerm_storage_blob" "{{ fw.name | replace('-', '_') }}_bootstrap_xml" {
  name                   = "config/bootstrap.xml"
  storage_account_name   = azurerm_storage_account.bootstrap.name
  storage_container_name = azurerm_storage_container.{{ fw.name | replace('-', '_') }}_bootstrap.name
  type                   = "Block"
  source                 = "${path.module}/bootstrap/{{ fw.name }}/config/bootstrap.xml"
}

{% endfor %}

{% if panorama %}
# =============================================================================
# Bootstrap Container for Panorama
# =============================================================================

resource "azurerm_storage_container" "panorama_bootstrap" {
  name                  = "{{ panorama.name }}-bootstrap"
  storage_account_name  = azurerm_storage_account.bootstrap.name
  container_access_type = "blob"
}

resource "azurerm_storage_blob" "panorama_init_cfg" {
  name                   = "config/init-cfg.txt"
  storage_account_name   = azurerm_storage_account.bootstrap.name
  storage_container_name = azurerm_storage_container.panorama_bootstrap.name
  type                   = "Block"
  source                 = "${path.module}/bootstrap/{{ panorama.name }}/config/init-cfg.txt"
}
{% endif %}

# =============================================================================
# Outputs
# =============================================================================

output "bootstrap_storage_account" {
  description = "Bootstrap storage account name"
  value       = azurerm_storage_account.bootstrap.name
}

output "bootstrap_storage_access_key" {
  description = "Bootstrap storage account access key"
  value       = azurerm_storage_account.bootstrap.primary_access_key
  sensitive   = true
}

{% for fw in firewalls %}
output "{{ fw.name | replace('-', '_') }}_bootstrap_url" {
  description = "Bootstrap container URL for {{ fw.name }}"
  value       = azurerm_storage_container.{{ fw.name | replace('-', '_') }}_bootstrap.id
}
{% endfor %}

{% endif %}
