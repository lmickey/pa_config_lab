# Data Preservation Fix - Critical Issue

## Problem Statement

**Current Behavior:**
- Pull process "normalizes" objects by extracting only specific fields
- Original API response data is **discarded**
- Critical fields like `allow_list`, `method` details, etc. are lost
- Push would fail because incomplete data is sent back

**Example:**
```json
// API Response (what we get)
{
  "id": "123",
  "name": "CIE-Okta",
  "folder": "All",
  "type": "authentication_profile",
  "method": {
    "cloud": {
      "profile_name": "okta-profile"
    }
  },
  "allow_list": ["user1@example.com", "user2@example.com"],
  "multi_factor_auth": true,
  "timeout": 30
}

// What we save (after normalization)
{
  "id": "123",
  "name": "CIE-Okta",
  "folder": "All",
  "type": "authentication_profile",
  "method": {},  // â† Lost details!
  "tags": [],
  "metadata": {}
}
// â† Lost: allow_list, multi_factor_auth, timeout
```

---

## Root Cause

All capture modules have `_normalize_*` methods that:
1. Extract only known/expected fields
2. Discard everything else
3. Were designed for "clean" output, not for round-trip push

**Affected Modules:**
- `profile_capture.py` - All profile types
- `object_capture.py` - All object types
- `rule_capture.py` - Security rules
- `folder_capture.py` - Folders
- `snippet_capture.py` - Snippets
- `infrastructure_capture.py` - All infrastructure

---

## Solution

### Option 1: Preserve Full Response (Recommended)

**Store the complete API response** with minimal processing:

```python
def _normalize_authentication_profile(self, prof_data: Dict[str, Any]) -> Dict[str, Any]:
    """Preserve full profile data for push."""
    # Make a copy of the entire response
    normalized = prof_data.copy()
    
    # Remove only the 'id' field (not needed for push)
    normalized.pop('id', None)
    
    # Ensure required fields exist (for our processing)
    normalized.setdefault('name', '')
    normalized.setdefault('folder', '')
    normalized.setdefault('type', 'authentication_profile')
    
    return normalized
```

**Benefits:**
- âœ… No data loss
- âœ… Push will work correctly
- âœ… Minimal code changes
- âœ… Future-proof (new API fields automatically included)

**Drawbacks:**
- Slightly larger config files
- May include read-only fields (need to remove before push)

### Option 2: Selective Preservation

Keep normalization but add `_original_data`:

```python
def _normalize_authentication_profile(self, prof_data: Dict[str, Any]) -> Dict[str, Any]:
    """Normalize with original data preserved."""
    return {
        "id": prof_data.get("id"),
        "name": prof_data.get("name", ""),
        "folder": prof_data.get("folder", ""),
        "type": prof_data.get("type", ""),
        # ... other normalized fields ...
        "_original_data": prof_data  # â† Preserve everything
    }
```

**Drawbacks:**
- Duplicates data
- More complex push logic

---

## Implementation Plan

### Phase 1: Fix Profile Capture (Immediate)

**File:** `prisma/pull/profile_capture.py`

**Changes:**
1. Update `_normalize_authentication_profile` to preserve all data
2. Update `_normalize_security_profile` to preserve all data
3. Update `_normalize_decryption_profile` to preserve all data
4. Remove `id` field only (not needed for push)

### Phase 2: Fix Object Capture

**File:** `prisma/pull/object_capture.py`

**Changes:**
1. Update all `_normalize_*` methods
2. Preserve full object data
3. Remove only `id` field

### Phase 3: Fix Rule Capture

**File:** `prisma/pull/rule_capture.py`

**Changes:**
1. Update `_normalize_security_rule`
2. Preserve all rule data including:
   - All action settings
   - All match criteria
   - All profile references

### Phase 4: Fix Infrastructure Capture

**File:** `prisma/pull/infrastructure_capture.py`

**Changes:**
1. Update all infrastructure normalization
2. Preserve full configuration data

### Phase 5: Fix Folder & Snippet Capture

**Files:** `prisma/pull/folder_capture.py`, `prisma/pull/snippet_capture.py`

**Changes:**
1. Preserve full folder/snippet data
2. Keep nested objects intact

---

## Fields to Remove Before Push

Some fields are **read-only** and must be removed before pushing:

```python
READ_ONLY_FIELDS = {
    'id',           # Generated by API
    'created_at',   # Timestamp
    'updated_at',   # Timestamp
    'created_by',   # User info
    'updated_by',   # User info
    'etag',         # Version control
    'version',      # Version number
}
```

These should be removed in the **push orchestrator**, not during pull.

---

## Testing Strategy

### Test 1: Authentication Profile Round-Trip
```
1. Pull authentication profile with allow_list
2. Save to file
3. Load from file
4. Verify allow_list is present
5. Push to test tenant
6. Verify profile works correctly
```

### Test 2: Security Rule Round-Trip
```
1. Pull security rule with all settings
2. Save to file
3. Load from file
4. Verify all action settings present
5. Push to test tenant
6. Verify rule works correctly
```

### Test 3: Service Connection Round-Trip
```
1. Pull service connection with all crypto settings
2. Save to file
3. Load from file
4. Verify all settings present
5. Push to test tenant
6. Verify connection works
```

---

## Estimated Impact

### Files to Modify:
1. `prisma/pull/profile_capture.py` - 3 normalize methods
2. `prisma/pull/object_capture.py` - ~10 normalize methods
3. `prisma/pull/rule_capture.py` - 1 normalize method
4. `prisma/pull/folder_capture.py` - 1 normalize method
5. `prisma/pull/snippet_capture.py` - 1 normalize method
6. `prisma/pull/infrastructure_capture.py` - ~8 normalize methods

### Estimated Time:
- Phase 1 (Profiles): 30 minutes
- Phase 2 (Objects): 1 hour
- Phase 3 (Rules): 30 minutes
- Phase 4 (Infrastructure): 1 hour
- Phase 5 (Folders/Snippets): 30 minutes
- Testing: 1 hour
- **Total: 4-5 hours**

---

## Priority

**CRITICAL** - Must fix before push implementation

Without this fix:
- âŒ Push will fail with incomplete data
- âŒ Configurations will be corrupted
- âŒ Users will lose critical settings
- âŒ System is not production-ready

---

## Next Steps

1. âœ… Create this plan document
2. âœ… Fix profile capture (authentication, security, decryption)
3. âœ… Fix object capture (addresses, services, applications, etc.)
4. âœ… Fix rule capture
5. âœ… Fix infrastructure capture (already preserving full data)
6. âœ… Fix folder/snippet capture
7. ðŸ”² Test round-trip for each type
8. ðŸ”² Update push orchestrator to remove read-only fields

---

## Implementation Complete! âœ…

### Files Modified:

1. **`prisma/pull/profile_capture.py`** âœ…
   - `_normalize_authentication_profile()` - Now preserves ALL fields
   - `_normalize_security_profile()` - Now preserves ALL fields
   - `_normalize_decryption_profile()` - Now preserves ALL fields

2. **`prisma/pull/object_capture.py`** âœ…
   - `_normalize_address()` - Now preserves ALL fields
   - `_normalize_address_group()` - Now preserves ALL fields
   - `_normalize_service()` - Now preserves ALL fields
   - `_normalize_service_group()` - Now preserves ALL fields
   - `_normalize_application()` - Now preserves ALL fields

3. **`prisma/pull/rule_capture.py`** âœ…
   - `_normalize_rule()` - Now preserves ALL fields

4. **`prisma/pull/infrastructure_capture.py`** âœ…
   - Already returning raw API data (no normalization)
   - No changes needed

5. **`prisma/pull/folder_capture.py`** âœ…
   - `_normalize_folder()` - Now preserves ALL fields

6. **`prisma/pull/snippet_capture.py`** âœ…
   - `_normalize_snippet()` - Now preserves ALL fields

### What Changed:

**Before:**
```python
def _normalize_authentication_profile(self, prof_data: Dict[str, Any]) -> Dict[str, Any]:
    return {
        "id": prof_data.get("id"),
        "name": prof_data.get("name", ""),
        "type": prof_data.get("type", ""),
        "method": prof_data.get("method", {}),  # â† Lost nested details!
        "folder": prof_data.get("folder", ""),
        "tags": [...],
        "metadata": {...}
    }
    # â† Lost: allow_list, multi_factor_auth, timeout, etc.
```

**After:**
```python
def _normalize_authentication_profile(self, prof_data: Dict[str, Any]) -> Dict[str, Any]:
    # Make a deep copy to preserve ALL fields
    normalized = prof_data.copy()
    
    # Remove ONLY the 'id' field (regenerated on push)
    normalized.pop('id', None)
    
    # Ensure required fields exist
    normalized.setdefault('name', '')
    normalized.setdefault('folder', '')
    normalized.setdefault('type', 'authentication_profile')
    
    # Add metadata for tracking
    if 'metadata' not in normalized:
        normalized['metadata'] = self._extract_metadata(prof_data)
    
    return normalized
    # âœ… ALL original fields preserved!
```

### Key Changes:

1. **Full Data Preservation**: All API response fields are now preserved
2. **Only Remove 'id'**: The 'id' field is removed (will be regenerated on push)
3. **Minimal Processing**: Only add required defaults and metadata
4. **Future-Proof**: New API fields automatically included

---

## Success Criteria

âœ… Pull captures ALL fields from API response
âœ… Saved configs contain complete data
âœ… Loaded configs have all original fields
âœ… Push sends complete, valid data
âœ… No data loss in round-trip process
âœ… All configuration types work correctly
